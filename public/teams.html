<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>MFFL ‚Ä¢ Teams</title>
<style>
  :root{ --bg:#0b1220; --panel:#121a2b; --border:#1e2a44; --text:#e6e9f2; --muted:#9fb0d2; --accent:#22c55e; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0d1425 40%);color:var(--text);font:15px system-ui,Segoe UI,Roboto,Arial;padding-bottom:env(safe-area-inset-bottom)}
  header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border);gap:12px;position:sticky;top:0;z-index:10;backdrop-filter:blur(6px)}
  h1{font-size:20px;margin:0}
  .tabs{display:flex;gap:10px;align-items:center}
  .tabs a{display:inline-block;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0e1728;color:#cfe2ff;text-decoration:none;white-space:nowrap}
  .tabs a.active{background:#14213b;border-color:#2b3a5e}

  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px;font-size:16px;color:#fff;gap:10px}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--border);background:#0e1728;color:#cfe2ff;padding:8px 10px;border-radius:10px;cursor:pointer;min-height:40px;touch-action:manipulation}
  .btn.ghost{background:transparent}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .input{border:1px solid var(--border);background:#0e1728;color:#e6e9f2;border-radius:10px;padding:8px 10px;min-height:40px}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  /* header right area */
  .header-right{display:flex;align-items:center;gap:10px; position:relative;}

  /* ===== Spiff Bank list ===== */
  .bank-list{display:grid;gap:10px}
  .bank-row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
    border:1px solid var(--border);
    background:#0a1324;
    border-radius:12px;
    padding:10px;
  }
  .left{display:flex;align-items:center;gap:10px;min-width:0}
  .avatar{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;background:#10203a;border:1px solid #1d3259;font-weight:700}
  .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{font-size:12px;color:#9fb0d2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .money{font-weight:800}
  .bank{display:flex;align-items:center;gap:10px}
  .amount{min-width:90px;text-align:right}
  .amt-input{
    width:120px;border:1px solid var(--border);background:#0e1728;color:#e6e9f2;border-radius:10px;padding:6px 8px;text-align:right;
    font-size:16px; /* prevent iOS zoom on focus */
  }
  .chips{display:none;gap:6px;flex-wrap:wrap}
  .chip{font-size:12px;border:1px solid var(--border);background:#0e1728;padding:4px 8px;border-radius:999px;cursor:pointer}
  body.editing .chips{display:flex}

  .editbar{display:none;gap:8px}
  body.is-commish .editbar{display:flex}

  /* ===== Notifications bell + popover ===== */
  .bell-btn{width:36px;height:36px;display:grid;place-items:center;border:1px solid var(--border);background:#0e1728;color:#cfe2ff;border-radius:10px;cursor:pointer}
  .bell-btn:hover{background:#14213b;border-color:#2b3a5e}
  .bell-dot{position:absolute;top:-4px;right:-4px;background:#22c55e;color:#06210f;border-radius:999px;font-size:11px;line-height:1;padding:2px 6px;border:1px solid #063d25}

  .notif-pop{position:absolute;top:calc(100% + 10px);right:0;width:min(92vw,380px);background:#0c1426;border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 40px rgba(0,0,0,.45);display:none;z-index:20}
  .notif-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
  .notif-title{font-weight:700}
  .notif-list{max-height:60vh;overflow:auto;padding:8px}
  .notif-item{display:flex;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0a1324;margin:8px 0}
  .notif-item .av{width:34px;height:34px;border-radius:50%;background:#10203a;border:1px solid #1d3259;flex:0 0 auto;display:grid;place-items:center;color:#cfe2ff;font-weight:700}
  .notif-item .av.hasimg{color:transparent;background-size:cover;background-position:center}
  .notif-meta{font-size:12px;color:var(--muted)}
  .notif-empty{padding:16px;color:var(--muted)}
  .notif-list{ scrollbar-width:thin; scrollbar-color:#1e2a44 transparent }
  .notif-list::-webkit-scrollbar{ width:10px }
  .notif-list::-webkit-scrollbar-track{ background:transparent }
  .notif-list::-webkit-scrollbar-thumb{ background:#1e2a44;border-radius:999px;border:2px solid transparent;background-clip:padding-box }
  .notif-list::-webkit-scrollbar-thumb:hover{ background:#2a3b5f }

  /* ===== Suggestion Box + Commish inbox ===== */
  .icon-btn{width:36px;height:36px;display:grid;place-items:center;border:1px solid var(--border);background:#0e1728;color:#cfe2ff;border-radius:10px;cursor:pointer;min-height:36px;touch-action:manipulation}
  .icon-btn:hover{background:#14213b;border-color:#2b3a5e}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:40}
  .modal{position:fixed;left:50%;top:16%;transform:translateX(-50%);width:min(92vw,520px);background:#0c1426;border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 40px rgba(0,0,0,.45);display:none;z-index:41}
  .modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
  .modal .bd{padding:12px 14px;display:grid;gap:10px}
  .textarea{min-height:120px;resize:vertical}
  .btn.ghost{background:transparent}

  .inbox-pop{position:absolute;top:calc(100% + 10px);right:0;width:min(92vw,420px);background:#0c1426;border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 40px rgba(0,0,0,.45);display:none;z-index:30}
  .inbox-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
  .inbox-list{max-height:60vh;overflow:auto;padding:8px; scrollbar-width:thin; scrollbar-color:#1e2a44 transparent}
  .inbox-item{border:1px solid var(--border);border-radius:12px;background:#0a1324;padding:10px;margin:8px 0}
  .inbox-when{font-size:12px;color:var(--muted)}
  .inbox-list::-webkit-scrollbar{ width:10px }
  .inbox-list::-webkit-scrollbar-track{ background:transparent }
  .inbox-list::-webkit-scrollbar-thumb{ background:#1e2a44;border-radius:999px;border:2px solid transparent;background-clip:padding-box }
  .inbox-list::-webkit-scrollbar-thumb:hover{ background:#2a3b5f }

  .toast{position:fixed;right:18px;bottom:18px;background:#10203a;color:#e6e9f2;border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:60;display:none}

  /* ========================= MOBILE OPTIMIZATIONS ========================= */
  @media (max-width: 800px){
    .wrap{padding:14px}
    .section-title{flex-wrap:wrap}
    .toolbar{width:100%}
    .toolbar .input{flex:1 1 240px;min-width:0}
  }
  @media (max-width: 700px){
    header{flex-wrap:wrap;gap:8px 10px;padding:12px 14px}
    h1{font-size:18px}
    h1{order:1}
    .header-right{order:2}
    .tabs{order:3;width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;gap:8px;scroll-snap-type:x mandatory;margin-inline:-4px;padding-inline:4px}
    .tabs a{scroll-snap-align:start;padding:10px 12px;font-size:14px}
    .tabs::-webkit-scrollbar{height:8px}
    .tabs{scrollbar-width:thin}

    .bank-row{grid-template-columns: 1fr; align-items:flex-start}
    .amount{text-align:left;min-width:auto}
  }
  @media (max-width: 420px){
    .toast{right:12px;bottom:calc(12px + env(safe-area-inset-bottom))}
    .notif-pop, .inbox-pop{right:12px;width:min(100vw - 24px, 420px)}
  }
</style>
</head>
<body>
  <header>
    <h1>MFFL ‚Ä¢ Teams</h1>
    <nav class="tabs" aria-label="Primary">
      <a href="/">Home</a>
      <a href="/app/docs.html">About</a>
      <a class="active" href="/app/teams.html">Spiff Bank</a>
      <a href="/app/bracket.html">Bracket</a>
      <a href="/app/cams.html">Cam‚Äôs Corner</a>
    </nav>

    <!-- Right cluster: suggest + commish + inbox + bell + logout -->
    <div class="header-right">
      <button id="suggestBtn" class="icon-btn" title="Submit a suggestion" aria-label="Submit a suggestion">üí°</button>
      <button id="commishBtn" class="icon-btn" title="Commissioner unlock" aria-label="Commissioner unlock">üîê</button>
      <button id="suggestInboxBtn" class="icon-btn" title="Suggestions inbox" aria-label="Open suggestions inbox" style="display:none">üì•</button>

      <!-- üì• Suggestions inbox popover -->
      <div id="suggestInbox" class="inbox-pop" role="dialog" aria-label="Suggestions Inbox">
        <div class="inbox-head">
          <div style="font-weight:700">Suggestion Inbox</div>
          <button id="inboxRefresh" class="btn" type="button">Refresh</button>
        </div>
        <div id="inboxList" class="inbox-list"><div class="muted" style="padding:10px">Loading‚Ä¶</div></div>
      </div>

      <!-- üîî Bell -->
      <button id="bellBtn" class="bell-btn" aria-label="Activity">&#128276;<span id="bellDot" class="bell-dot" style="display:none">‚Ä¢</span></button>
      <!-- Popover -->
      <div id="notifPop" class="notif-pop" role="dialog" aria-label="Activity" aria-modal="false">
        <div class="notif-head">
          <div class="notif-title">Activity</div>
          <button id="notifRefresh" class="btn" type="button">Refresh</button>
        </div>
        <div id="notifList" class="notif-list"><div class="notif-empty">Loading‚Ä¶</div></div>
      </div>

      <form method="POST" action="/logout"><button class="btn" type="submit">Log out</button></form>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="section-title">
        <span>üí∞ Spiff Accrual Bank</span>
        <div class="toolbar" role="group" aria-label="Spiff tools">
          <input id="q" class="input" placeholder="Filter managers / teams‚Ä¶"/>
          <select id="sortSel" class="input" aria-label="Sort">
            <option value="bank-desc" selected>Sort: Bank (high‚Üílow)</option>
            <option value="bank-asc">Sort: Bank (low‚Üíhigh)</option>
            <option value="team">Sort: Team</option>
            <option value="manager">Sort: Manager</option>
          </select>
          <div class="editbar" id="editBar">
            <button id="toggleEdit" class="btn" type="button">Edit banks</button>
            <button id="saveBanks" class="btn" type="button" disabled>Save</button>
          </div>
        </div>
      </div>
      <div id="bankList" class="bank-list"></div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* =================== Config =================== */
const SPIFFS_API = '/api/spiffs';   // GET -> { banks: { "<roster_id>": number } }
                                    // PUT/POST -> { banks: { "<roster_id>": number } } -> 200/204 (optionally { ok:true })
let isCommish = false;
let editMode = false;
let dirty = false;

const state = {
  teams: [],     // from /api/league
  banks: {},     // from /api/spiffs
  view: []       // merged for rendering
};

/* =================== Helpers =================== */
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(()=> t.style.display='none', 2200);
}
function initialAvatar(name, emoji){ if (emoji) return emoji; const initials=(name||'?').split(/\s+/).map(s=>s[0]||'').slice(0,2).join('').toUpperCase(); return initials||'üôÇ'; }
function fmtMoney(n){ return '$' + (Number(n||0)).toFixed(2); }
function parseMoney(s){
  if (typeof s === 'number') return s;
  s = String(s||'').replace(/[^0-9.\-]/g,'');
  const v = parseFloat(s);
  return isNaN(v) ? 0 : Math.round(v * 100) / 100;
}
function avatarStyle(url){
  return url ? `style="background-image:url('${url}');background-size:cover;background-position:center;color:transparent;"` : '';
}
function setEditable(on){
  document.body.classList.toggle('editing', !!on);
  document.getElementById('saveBanks').disabled = !dirty;
  document.getElementById('toggleEdit').textContent = on ? 'Done editing' : 'Edit banks';
}
function markDirty(){ dirty = true; if (isCommish) document.getElementById('saveBanks').disabled = false; }

/* Re-render if sorting by bank (no focusing of inputs to avoid keyboard pop) */
function rerenderIfSortedByBank(){
  const mode = document.getElementById('sortSel').value;
  if (mode === 'bank-desc' || mode === 'bank-asc'){
    // Ensure no element is focused (especially an input) before re-render
    if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
    renderList();
  }
}

/* =================== Data load / save =================== */
async function loadLeague(){
  const r = await fetch('/api/league', { credentials:'include' });
  const data = await r.json();
  state.teams = (data.roster||[]).map(m=>({
    roster_id: m.roster_id,
    team: m.team || 'Team',
    manager: m.manager || '',
    avatarThumb: m.avatarThumb || m.avatarFull || '',
    emoji: m.emoji || ''
  }));
}
async function loadBanks(){
  try{
    const r = await fetch(SPIFFS_API, { credentials:'include' });
    if (!r.ok) throw new Error();
    const j = await r.json();
    state.banks = j.banks || {};
  }catch{
    state.banks = {};
  }
}

/* More tolerant save: try PUT, then POST fallback; accept 2xx with/without {ok:true} */
async function saveBanks(){
  const payload = { banks: {} };
  state.view.forEach(row=>{
    payload.banks[row.roster_id] = Number(row.bank) || 0;
  });

  async function trySave(method, url){
    const res = await fetch(url, {
      method,
      credentials:'include',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    // some servers return 204 No Content
    let data = null;
    try{ data = await res.json(); }catch{}
    if (data && data.ok === false) throw new Error(data.error || 'Server reported failure');
    return data;
  }

  try{
    try{
      await trySave('PUT', SPIFFS_API);
    }catch(e1){
      // fallback to POST same URL
      await trySave('POST', SPIFFS_API);
    }
    dirty = false; document.getElementById('saveBanks').disabled = true;
    showToast('Banks saved.');
  }catch(err){
    const msg = (err && err.message) ? `Save failed: ${err.message}` : 'Save failed.';
    showToast(msg);
    console.error('Spiffs save error:', err);
  }
}

/* =================== Rendering =================== */
function buildView(){
  state.view = state.teams.map(t=>{
    const bank = typeof state.banks[t.roster_id] === 'number' ? state.banks[t.roster_id] : 0;
    return { ...t, bank };
  });
}
function sortView(mode){
  if (mode === 'manager'){
    state.view.sort((a,b)=>a.manager.localeCompare(b.manager));
  }else if (mode === 'bank-desc'){
    state.view.sort((a,b)=>b.bank - a.bank);
  }else if (mode === 'bank-asc'){
    state.view.sort((a,b)=>a.bank - b.bank);
  }else{
    state.view.sort((a,b)=>a.team.localeCompare(b.team)); // default team
  }
}
function rowHTML(row){
  const initials = initialAvatar(row.manager, row.emoji);
  const bankStr = fmtMoney(row.bank);
  const input = `<input class="amt-input" data-id="${row.roster_id}" type="text" inputmode="decimal" value="${row.bank.toFixed(2)}" aria-label="Edit amount for ${row.team}" />`;
  return `
  <div class="bank-row" data-id="${row.roster_id}">
    <div class="left">
      <div class="avatar" ${avatarStyle(row.avatarThumb)}>${initials}</div>
      <div style="min-width:0">
        <div class="title">${row.team}</div>
        <div class="sub">${row.manager}</div>
      </div>
    </div>
    <div class="bank">
      <div class="amount money" data-label>${bankStr}</div>
      ${isCommish && editMode ? input : ''}
      <div class="chips">
        <button class="chip inc" data-inc="5">+$5</button>
        <button class="chip inc" data-inc="10">+$10</button>
        <button class="chip inc" data-inc="25">+$25</button>
        <button class="chip inc" data-inc="-5">‚àí$5</button>
      </div>
    </div>
  </div>`;
}
function renderList(){
  const wrap = document.getElementById('bankList');
  const q = document.getElementById('q').value.toLowerCase();
  const mode = document.getElementById('sortSel').value;
  sortView(mode);

  const filtered = state.view.filter(v=>{
    const text = (v.team + ' ' + v.manager).toLowerCase();
    return text.includes(q);
  });
  wrap.innerHTML = filtered.map(rowHTML).join('') || `<div class="muted">No teams found.</div>`;

  if (isCommish){
    // quick-add chips (no focus; no keyboard)
    document.querySelectorAll('.bank-row .inc').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        // ensure nothing focused so mobile keyboard won't appear
        if (document.activeElement && document.activeElement.blur) document.activeElement.blur();

        const rowEl = btn.closest('.bank-row');
        const id = rowEl.getAttribute('data-id');
        const delta = parseFloat(btn.getAttribute('data-inc')) || 0;
        const row = state.view.find(r=>String(r.roster_id)===String(id));
        if (!row) return;
        row.bank = Math.max(0, Math.round((row.bank + delta)*100)/100);
        const label = rowEl.querySelector('[data-label]');
        if (label) label.textContent = fmtMoney(row.bank);
        const input = rowEl.querySelector('.amt-input');
        if (input) input.value = row.bank.toFixed(2);
        markDirty();

        // Re-sort if sorting by bank ‚Äî still without focusing inputs
        rerenderIfSortedByBank();
      }, {passive:true});
    });

    // inputs update (for manual edits)
    document.querySelectorAll('.amt-input').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const id = inp.getAttribute('data-id');
        const row = state.view.find(r=>String(r.roster_id)===String(id));
        if (!row) return;
        row.bank = parseMoney(inp.value);
        const label = inp.closest('.bank').querySelector('[data-label]');
        if (label) label.textContent = fmtMoney(row.bank);
        markDirty();
      });
      inp.addEventListener('blur', ()=>{
        const id = inp.getAttribute('data-id');
        const v = parseMoney(inp.value);
        inp.value = v.toFixed(2);
        const row = state.view.find(r=>String(r.roster_id)===String(id));
        if (row) row.bank = v;
        // Resort if needed; no focusing back
        rerenderIfSortedByBank();
      });
    });
  }
}

/* ===================== Notifications UI ===================== */
const bellBtn = document.getElementById('bellBtn');
const bellDot = document.getElementById('bellDot');
const notifPop = document.getElementById('notifPop');
const notifList = document.getElementById('notifList');
const notifRefresh = document.getElementById('notifRefresh');
let notifLoaded = false;

function timeAgo(iso){
  const s = Math.floor((Date.now() - new Date(iso).getTime())/1000);
  const m = Math.floor(s/60), h = Math.floor(m/60), d = Math.floor(h/24);
  if (d>0) return d+'d ago'; if (h>0) return h+'h ago'; if (m>0) return m+'m ago'; return 'just now';
}
function notifAvatar(team){
  const url = team?.avatarThumb;
  if (url) return `<div class="av hasimg" style="background-image:url('${url}')">.</div>`;
  const init = (team?.team||'?').split(/\s+/).map(s=>s[0]||'').slice(0,2).join('').toUpperCase() || 'üôÇ';
  return `<div class="av">${init}</div>`;
}
function describeTx(t){
  const tlabel = ({waiver:'waiver', free_agent:'free agent', trade:'trade', draft:'draft'}[t.type]) || t.type;
  if (t.type==='trade' && t.rosters?.length>=2){
    const a=t.rosters[0]?.team, b=t.rosters[1]?.team;
    return `<strong>${a}</strong> ‚Üî <strong>${b}</strong> completed a trade.`;
  }
  const add = t.adds?.[0];
  const drop = t.drops?.[0];
  if (add && drop){
    return `<strong>${add.to.team}</strong> added <strong>${add.name}</strong> and dropped <strong>${drop.name}</strong> (${tlabel}).`;
  }
  if (add){
    return `<strong>${add.to.team}</strong> added <strong>${add.name}</strong> (${tlabel})${t.waiver_bid?` for $${t.waiver_bid}`:''}.`;
  }
  if (drop){
    return `<strong>${drop.from.team}</strong> dropped <strong>${drop.name}</strong>.`;
  }
  return `${t.type} activity.`;
}
async function loadNotifications(force=false){
  if (notifLoaded && !force) return;
  notifList.innerHTML = `<div class="notif-empty">Loading‚Ä¶</div>`;
  try{
    const r = await fetch('/api/sleeper/transactions', { credentials:'include' });
    const data = await r.json();
    const items = (data.items||[]);
    bellDot.style.display = items.length ? '' : 'none';
    if (!items.length){
      notifList.innerHTML = `<div class="notif-empty">No recent activity.</div>`;
      notifLoaded = true; return;
    }
    notifList.innerHTML = items.map(t=>{
      const team = (t.rosters&&t.rosters[0]) || null;
      return `<div class="notif-item">
        ${notifAvatar(team)}
        <div>
          <div>${describeTx(t)}</div>
          <div class="notif-meta">${timeAgo(t.when)} ‚Ä¢ Week ${t.round}</div>
        </div>
      </div>`;
    }).join('');
    notifLoaded = true;
  }catch(e){
    notifList.innerHTML = `<div class="notif-empty">Could not load activity.</div>`;
  }
}
function toggleNotif(){
  const open = notifPop.style.display === 'block';
  if (open){ notifPop.style.display = 'none'; }
  else { notifPop.style.display = 'block'; loadNotifications(false); }
}
document.getElementById('bellBtn').addEventListener('click', (e)=>{ e.stopPropagation(); toggleNotif(); });
notifRefresh.addEventListener('click', (e)=>{ e.stopPropagation(); notifLoaded=false; loadNotifications(true); });
document.addEventListener('click', (e)=>{
  if (notifPop.style.display==='block' && !notifPop.contains(e.target) && e.target!==bellBtn){
    notifPop.style.display='none';
  }
});

/* ================= Suggestion Box + Commish ================= */
const modalBackdrop = document.getElementById('modalBackdrop') || (function(){
  const el = document.createElement('div'); el.id='modalBackdrop'; el.className='modal-backdrop'; document.body.appendChild(el); return el;
})();
function ensureModal(id, html){
  if (!document.getElementById(id)) {
    const div = document.createElement('div'); div.innerHTML = html; document.body.appendChild(div);
  }
}
ensureModal('suggestModal', `
<div id="suggestModal" class="modal" role="dialog" aria-label="Submit a suggestion">
  <div class="hd">
    <div style="font-weight:700">Submit a suggestion</div>
    <button class="btn ghost" type="button" onclick="(document.getElementById('suggestModal').style.display='none', document.getElementById('modalBackdrop').style.display='none')">‚úï</button>
  </div>
  <form id="suggestForm" class="bd">
    <input class="input" name="name" placeholder="Your name (optional)"/>
    <textarea class="textarea input" name="text" placeholder="Your suggestion‚Ä¶" required></textarea>
    <div class="row" style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn ghost" type="button" onclick="(document.getElementById('suggestModal').style.display='none', document.getElementById('modalBackdrop').style.display='none')">Cancel</button>
      <button class="btn" type="submit">Send</button>
    </div>
  </form>
</div>`);
ensureModal('commishModal', `
<div id="commishModal" class="modal" role="dialog" aria-label="Commissioner unlock">
  <div class="hd">
    <div style="font-weight:700">Commissioner unlock</div>
    <button class="btn ghost" type="button" onclick="(document.getElementById('commishModal').style.display='none', document.getElementById('modalBackdrop').style.display='none')">‚úï</button>
  </div>
  <form id="commishForm" class="bd">
    <input class="input" name="commish_password" type="password" placeholder="Commissioner password" required/>
    <div class="row" style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn ghost" type="button" onclick="(document.getElementById('commishModal').style.display='none', document.getElementById('modalBackdrop').style.display='none')">Cancel</button>
      <button class="btn" type="submit">Unlock</button>
    </div>
  </form>
</div>`);
if (!document.getElementById('toast')){
  const t = document.createElement('div'); t.id='toast'; t.className='toast'; document.body.appendChild(t);
}

const suggestBtn = document.getElementById('suggestBtn');
const commishBtn = document.getElementById('commishBtn');
const inboxBtn   = document.getElementById('suggestInboxBtn');
const inboxPop   = document.getElementById('suggestInbox');
const inboxList  = document.getElementById('inboxList');
const inboxRefresh = document.getElementById('inboxRefresh');
const suggestForm = document.getElementById('suggestForm');
const commishForm = document.getElementById('commishForm');

function openModal(el){ modalBackdrop.style.display='block'; el.style.display='block'; }
function closeModal(el){ el.style.display='none'; modalBackdrop.style.display='none'; }

suggestBtn.addEventListener('click', ()=> openModal(document.getElementById('suggestModal')));
commishBtn.addEventListener('click', ()=> openModal(document.getElementById('commishModal')));
modalBackdrop.addEventListener('click', ()=>{ closeModal(document.getElementById('suggestModal')); closeModal(document.getElementById('commishModal')); });

if (suggestForm){
  suggestForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(suggestForm);
    const payload = { name: fd.get('name')||'', text: fd.get('text')||'' };
    try{
      const r = await fetch('/api/suggestions', { method:'POST', headers:{ 'content-type':'application/json' }, credentials:'include', body: JSON.stringify(payload) });
      const j = await r.json();
      if (!r.ok || j.ok === false) throw new Error(j.error || 'Failed');
      suggestForm.reset();
      closeModal(document.getElementById('suggestModal'));
      showToast('Suggestion submitted. Thanks!');
    }catch{ showToast('Could not submit suggestion.'); }
  });
}
if (commishForm){
  commishForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(commishForm);
    try{
      const r = await fetch('/commish-login', {
        method:'POST',
        headers:{ 'content-type':'application/x-www-form-urlencoded' },
        credentials:'include',
        body: new URLSearchParams({ commish_password: fd.get('commish_password') })
      });
      const j = await r.json();
      if (!r.ok || j.ok === false) throw new Error(j.error || 'Failed');
      isCommish = true;
      document.body.classList.add('is-commish');
      document.getElementById('suggestInboxBtn').style.display = '';
      showToast('Commissioner unlocked.');
    }catch{ showToast('Invalid commissioner password.'); }
    closeModal(document.getElementById('commishModal'));
  });
}

async function loadInbox(force=false){
  if (!isCommish) return;
  if (force) inboxList.innerHTML = '<div class="muted" style="padding:10px">Loading‚Ä¶</div>';
  try{
    const r = await fetch('/api/suggestions', { credentials:'include' }); const data = await r.json();
    if (!r.ok) throw new Error();
    const items = data.items || [];
    if (!items.length){
      inboxList.innerHTML = '<div class="muted" style="padding:10px">No suggestions yet.</div>';
      return;
    }
    inboxList.innerHTML = items.map(s => `
      <div class="inbox-item">
        <div class="inbox-when">${new Date(s.when).toLocaleString()}</div>
        <div style="margin-top:6px">${(s.name ? `<strong>${String(s.name).replace(/</g,'&lt;')}</strong>: ` : '')}${String(s.text||'').replace(/</g,'&lt;')}</div>
      </div>`).join('');
  }catch{
    inboxList.innerHTML = '<div class="muted" style="padding:10px">Could not load suggestions.</div>';
  }
}
inboxBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  const open = inboxPop.style.display === 'block';
  inboxPop.style.display = open ? 'none' : 'block';
  if (!open) loadInbox(true);
});
inboxRefresh.addEventListener('click', (e)=>{ e.stopPropagation(); loadInbox(true); });
document.addEventListener('click', (e)=>{
  if (inboxPop.style.display === 'block' && !inboxPop.contains(e.target) && e.target !== inboxBtn) {
    inboxPop.style.display = 'none';
  }
});

/* ---------- Edit bar actions ---------- */
document.getElementById('toggleEdit').addEventListener('click', ()=>{
  if (!isCommish) return;
  editMode = !editMode;
  setEditable(editMode);
  renderList();
});
document.getElementById('saveBanks').addEventListener('click', async ()=>{
  await saveBanks();
  editMode = false; setEditable(false);
});

/* ---------- Filters / Sort ---------- */
document.getElementById('q').addEventListener('input', ()=>renderList(), {passive:true});
document.getElementById('sortSel').addEventListener('change', ()=>renderList(), {passive:true});

/* ---------- Init ---------- */
(async function init(){
  try{ const r = await fetch('/api/me', { credentials:'include' }); const me = await r.json(); isCommish = !!me.is_commish; }catch{}
  if (isCommish){ document.body.classList.add('is-commish'); document.getElementById('suggestInboxBtn').style.display=''; }

  // Ensure default sort is bank-desc
  document.getElementById('sortSel').value = 'bank-desc';

  await loadLeague();
  await loadBanks();
  buildView();
  renderList();
})();
</script>
</body>
</html>
